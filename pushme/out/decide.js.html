<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: decide.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: decide.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileOverview データを取得して必要な件数を抽出し、HTML出力します。
 * @copyright PushMe Studio 2015
 */

decideAjax = (function(){
	var storedData; // データの取得を一度に抑えるために共通で使う
	var originalData; //絞り込み前の状態を保存

	/**
	　* decideAjax.jsが読み込まれる際に呼び出される。
	　* データ取得後、事前に設定した件数分ランダムに抽出し、
	　* 呼び出し元のhtml上に書き出す。
	　*
	　* 又、このjsの読み込みの初回のみカテゴリの一覧を読み込む。
    　* 画面上に表示されているもののサイズ(特に高さ)を変えるようなイベントを起こす場合は、
     * 必ず、ads_utilsのfooterFixed()を呼んでください。
	*/
	$(function(){
		openDB().then(function(){
			// DBからすべてのレコードを取得
			getAllItemsfromDB().then(function(items){
				storedData = items;
				// 取得したレコードからカテゴリ一覧を作成し、プルダウンに追加
				var categoryOptionsHtml = makeCateOptionsHtml(storedData);
				$('#queryId').append(categoryOptionsHtml);
				getRandomItem();
			}, function(err){
				console.error(err);
			});
		}, function(err){
			console.error(err);
		});
	});

	/**
	 * カテゴリの選択が行われた際に呼び出される。
	 * 選択肢をランダムに取得し直す。
	 */
	$('#queryId').change(function(){
		getRandomItem();
	});

	/**
	 * 表示する件数の設定
	 */
	var fewAmount = 4;
	var normalAmount = 8;
	var manyAmount = 12;
	/**
	 * 件数が変更されたとき呼び出される。
	 * 件数を更新し、ランダムに取得し直す。
	 */
	$('#view_few').click(function(){
		setExtractAmount(fewAmount);
		getRandomItem();
	});

	$('#view_normal').click(function(){
		setExtractAmount(normalAmount);
		getRandomItem();
	});

	$('#view_many').click(function(){
		setExtractAmount(manyAmount);
		getRandomItem();
	});

	/**
	 * データ取得後、事前に設定した件数分ランダムに抽出し、
	 * 呼び出し元のhtml上に書き出す。
	 *
	 * データが少量の場合はajaxは必要ないが、総データ量が多くなった場合、
	 * extractByCate()に時間がかかる可能性があるため、ajaxによる処理が必要。
	 */
	var getRandomItem = function(){
		//decisionブロックのクリア
		if(decideAnimtion != null){
			clearInterval(decideAnimtion);
			decideAnimtion = null;
		}
		$('#decision').html("");
		//ボタンの初期設定
		$('#narrow').prop("disabled", true);
		$('#reset').prop("disabled", true);
		$('#clip').prop("disabled", true);
		$('#share').prop("disabled", true);
		$('#decide').prop("disabled", false);
		var queryData = {"tag" : $('#queryId').val()};
		$.ajax({
			type: "GET",
			success: function(){
				var categorisedData = extractByCate(storedData, queryData.tag);
				var extData = randomExtract(categorisedData);
				originalData = extData;
				var itemListHtml = makeItemListHtml(extData);
				$('#itemlist').html(itemListHtml);
				//各種イベント付与
                extendLabel();
				makeIsChecked();
			},
			error: function(err){
                console.error(err);
			}
		});
	};

	/**
	* 絞り込み解除が押下された際に呼び出される。
	* 絞り込み前の状態に戻す。
	*/
	resetItem = function(){
		$('#reset').prop("disabled", true);
		$.ajax({
			type: "GET",
			success: function(){
				var itemListHtml = makeItemListHtml(originalData);
				$('#itemlist').html(itemListHtml);

                extendLabel();
				makeIsChecked();
                
			},
			error: function(err){
                console.error(err);
			}
		});
	};

	/**
	* クリップが押下された際に呼び出される。
	* 決定された選択肢をクリップ
	*/
	clipItem = function(){
		clipName=$('#id').val();
		addClip(clipName);//database.jsのaddClipメソッド呼出し
	};

	/**
	* チェックによる絞り込みを行う。
	* チェックされた選択肢のみを残す。
	*/
	narrowItems = function(){
		$('#narrow').prop("disabled", true);
		$('#reset').prop("disabled", false);
		itemlist = $('[name="item"]');
		itemlist.each(function(){
			if($(this).prop("checked")){
				$(this).prop("checked", true);
			} else {
				$(this).parents('div[name="arrow"]').remove();
			}
		});
        
	};
	
	/**utilityに選択肢を連携*/
	shareItem = function(){
		shareText(choice)
	};
	
	/**アニメーション判定用の変数。
	*  アニメーション前 : decideAnimtion = null
	*  アニメーション中、後 : decideAnimtion > 0 
	*  getRandomItemが呼び出されるたびnullがセットされる。
	*/
	var decideAnimtion;

	/**
	* 最終決定を行う。
	* ランダムな抽選15回と決定後5回点滅。
	* 決定した選択肢はdecisionブロックにhiddenで記録。
	*/
	decideItem = function(){
		$('#decide').prop("disabled", true);
		$('#narrow').prop("disabled", true);
		$('#reset').prop("disabled", true);
		var itemlist = $(':checkbox[name="item"]:checked').parent('div[name="card"]');
		var i = 0;
		var count = 0;
		var hitCardNo = 0;
		//決定のアニメーション。15回目の抽選で決定。決定後5回点滅。
		decideAnimtion = setInterval(function(){
			// itemlist.get(index)が返す値はjQuery ObjectではなくDOM Elementであるため、$()を使用してjQuery Objectに変換する必要がある
			//背景色の戻し
			$(itemlist.get(hitCardNo)).animate({ backgroundColor: "#eeeeee", borderColor: "#0000ff" }, 100);
			hitCardNo = Math.floor(itemlist.length * Math.random());
			//背景色変更
			$(itemlist.get(hitCardNo)).animate({ backgroundColor: "#ffff77", borderColor: "#ffff77" }, 100);
			i++;
			if(i == 15){
				clearInterval(decideAnimtion);
				countId = setInterval(function(){
					$(itemlist.get(hitCardNo)).fadeOut(300, function(){$(this).fadeIn(300)});
					count++;
					if(count == 5){
						clearInterval(countId);
					}
				}, 1000);
				//お店の名前(title)を取得
				decision = "";
				choice = $(itemlist.get(hitCardNo)).children('div[name="subj"]').text();

				decision += '&lt;form id="addclip" action="/addclip" method="post" class="pure-form">';
				decision += '&lt;input type="hidden" id="id" name="subj" value="' + choice + '">';
				
				$('#decision').html(decision);
				$('#clip').prop("disabled", false);
				$('#share').prop("disabled", false);
			}
		}, 300)
	};

	// 詳細表示
	$('#itemlist').on("click", '.accordion button[name="detail"]', function(){
		$(this).parents('div[name="card"]').next("ul").slideToggle();
		$(this).toggleClass("open");
	});
	
	 /**
     * ラベル領域の拡張。
     * カードのクリックでチェックボックスのつけはずしを行う。
     * ただし、カードの部品（チェックボックス、ラベル、詳細ボタン）がクリックされた場合は
     * この関数内でのチェックボックス状態の変更は行わない。
     */
	var extendLabel = function(){
		var part_flag = false;
		$('#itemlist').find('button[name="detail"]').click(function(){
			part_flag = true;
		});
		$('#itemlist').find('input[type="checkbox"]').click(function(){
			part_flag = true;
			makeIsChecked();
		});
		$('#itemlist').find('label').click(function(){
			part_flag = true;
			makeIsChecked();
		});
		
		$('#itemlist').find('div[name="card"]').click(function(){
			if(part_flag){
				part_flag = false;
				return;
			}
			var checkbox = $(this).children('input[type="checkbox"]');
			if(checkbox.is(':checked')){
				checkbox.prop('checked', false);
			}else{
				checkbox.prop('checked', true);
			}
			makeIsChecked();
		});
	}

	 /**
     * チェックボックスとボタンの連携
     * allItems : カードの総数
     * checkedItems : チェックされているカードの数
     */
	var makeIsChecked = function(){
		if(!decideAnimtion){
			var allItems = $('#itemlist').find('input[type="checkbox"]').length;
			var checkedItems = $('#itemlist').find('input[type="checkbox"]').filter(":checked").length;
			if(checkedItems &lt;= 0){//チェック数=0：絞込、決定不可
				$('#narrow').prop("disabled", true);
				$('#decide').prop("disabled", true);
			}else if(checkedItems > 0 &amp;&amp; checkedItems &lt; allItems){//カード数>チェック数>0：絞込、決定可
				$('#narrow').prop("disabled", false);
				$('#decide').prop("disabled", false);
			}else if(checkedItems == allItems){//カード数=チェック数：絞込不可、決定可
				$('#narrow').prop("disabled", true);
				$('#decide').prop("disabled", false);
			}
		}
	};

	/**
	 * 受け取ったデータ及びデータ抽出件数に基づき、ランダムにデータを抽出する。
	 * データが件数以下の場合は全件出力する。この場合にはランダムな並び替えは実施しない。
	 * @param {String|Array} originalData 抽出対象となる元データ
	 * @param {number} extractAmount 抽出件数
	 * @return {String|Array} データから指定条件に基づいた抽出
	 */
	var randomExtract = function(originalData, extractAmount){
		if(typeof extractAmount === "undefined"){
			extractAmount = getExtractAmount();
		}
		var extractedData = new Array();
		var originalDataLength = originalData.length;

		if(originalDataLength &lt;= extractAmount){
			extractedData = originalData; // 実データ数が抽出したい数以下のため抽出する必要がない

		} else {
			var extractNumberArray = new Array();
			for(var i = 0; i &lt; extractAmount; i++){
				var candidateNumber = Math.round(Math.random() * (originalDataLength - 1));// Lengthと同じ値のインデックスだと配列の長さを超える
				if(extractNumberArray.indexOf(candidateNumber) != -1){
					i--;//今回の回をなかったことにしてもう一度やり直させる
				}else{
					extractNumberArray.push(candidateNumber); // 重複を防ぐ
					extractedData.push(originalData[candidateNumber]); // 抽出したデータを挿入
				}
			}
		}
		return extractedData;
	};

	/**
	 * 受け取ったデータからhtml上にリストを作成する
	 * @param {String|Array} extData 抽出済みのデータ
	 * @return {String} itemListを構成するタグ
	 */
	var makeItemListHtml = function(extData){
		var itemListHtml = "";
		if(extData.length > 0){
			itemListHtml += '&lt;form name="itemlist" class="pure-form pure-form-aligned">';
			itemListHtml += '&lt;div class="pure-g">';
			itemListHtml += '&lt;span class="accordion">';

			for(var i = 0, n = extData.length; i &lt; n; i++){
				var subj = extData[i].subject;
				var cate = extData[i].category;
				var note = extData[i].note;

				itemListHtml += '&lt;div name="arrow" class="pure-u-1">';
				itemListHtml += '&lt;div name="card">&lt;input type="checkbox" name="item" id="item' + i + '" checked="checked">';
				itemListHtml += '&lt;div name="subj" class="subject-decide">&lt;label for="item' + i + '">' + subj + '&lt;/label>&lt;/div>';
				itemListHtml += '&lt;div name="buttons">&lt;button type="button" name="detail" class="pure-button">&lt;img src="../img/accordion.png">&lt;/button>&lt;/div>&lt;/div>';
				itemListHtml += '&lt;ul>';
				itemListHtml += '&lt;li>[' + cate + ']&lt;/li>';
				itemListHtml += '&lt;li>' + note + '&lt;/li>&lt;/ul>&lt;/div>';
			}
			itemListHtml += '&lt;/span>&lt;/div>&lt;/div>';
			itemListHtml += "&lt;/form>";
		} else {
			itemListHtml = '&lt;p name="itemlist">Results not found&lt;/p>';
		}
		return itemListHtml;
	};

	var extractAmount = 4;
	/**
	* 抽出件数をセットする
	* @param {String} cvalue 抽出件数としてセットしたい値 数値以外や1未満の場合は既定値でセットする
	*/
	var setExtractAmount = function(cvalue) {
		var defaultAmount = 4;
		var configValue = parseInt(cvalue);

		if (typeof configValue === 'number' &amp;&amp; configValue > 0) {
			extractAmount = Math.ceil(configValue); // 小数点を受け取ってしまった場合の対処
		} else {
			extractAmount = defaultAmount;
		}
	}

	/**
	* 抽出件数をゲットする
	* @return {number} extractAmount セット済の抽出件数
	*/
	var getExtractAmount = function() {
		return extractAmount;
	}

})();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Global</h3><ul><li><a href="global.html#addClip">addClip</a></li><li><a href="global.html#addItemtoDB">addItemtoDB</a></li><li><a href="global.html#clipOnRegitemlist">clipOnRegitemlist</a></li><li><a href="global.html#delItemFromDB">delItemFromDB</a></li><li><a href="global.html#extractByCate">extractByCate</a></li><li><a href="global.html#fixAdFooter">fixAdFooter</a></li><li><a href="global.html#formatForSend">formatForSend</a></li><li><a href="global.html#getAllItemsfromDB">getAllItemsfromDB</a></li><li><a href="global.html#getCategorizedItemsfromDB">getCategorizedItemsfromDB</a></li><li><a href="global.html#getClippedItemsfromDB">getClippedItemsfromDB</a></li><li><a href="global.html#getTimeStamp">getTimeStamp</a></li><li><a href="global.html#getUniqueItemfromDB">getUniqueItemfromDB</a></li><li><a href="global.html#initDB">initDB</a></li><li><a href="global.html#makeCateOptionsHtml">makeCateOptionsHtml</a></li><li><a href="global.html#makeCateOptionsHtmlExceptAll">makeCateOptionsHtmlExceptAll</a></li><li><a href="global.html#makeShownItemListHtml">makeShownItemListHtml</a></li><li><a href="global.html#offClipfromDB">offClipfromDB</a></li><li><a href="global.html#openDB">openDB</a></li><li><a href="global.html#reloadqueryIdChangeFunc">reloadqueryIdChangeFunc</a></li><li><a href="global.html#shareText">shareText</a></li><li><a href="global.html#updateItemtoDB">updateItemtoDB</a></li><li><a href="global.html#updateStoredData">updateStoredData</a></li><li><a href="global.html#updateStoredDataForClipOnRegitemlist">updateStoredDataForClipOnRegitemlist</a></li><li><a href="global.html#updateStoredDataForDeleteProcess">updateStoredDataForDeleteProcess</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha10</a> on Mon Feb 16 2015 10:16:01 GMT+0900 (東京 (標準時))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
